<!DOCTYPE html>
<html lang="en">

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">


        <title>Dermatologist-ai</title>

            <link href="https://cihansoylu.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Cihan Soylu's Blog Full Atom Feed" />
            <link href="https://cihansoylu.github.io/blog/feeds/deep-learning.atom.xml" type="application/atom+xml" rel="alternate" title="Cihan Soylu's Blog Categories Atom Feed" />
        <!-- Bootstrap Core CSS -->
        <link href="https://cihansoylu.github.io/blog/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="https://cihansoylu.github.io/blog/theme/css/clean-blog.min.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="https://cihansoylu.github.io/blog/theme/css/code_blocks/darkly.css" rel="stylesheet">


        <!-- Custom Fonts -->
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->



        <meta name="description" content="Load dataset from sklearn.datasets import load_files from keras.utils import np_utils import numpy as np from glob import glob # define...">

        <meta name="author" content="Cihan Soylu">

        <meta name="tags" content="Keras">
        <meta name="tags" content="CNN">
        <meta name="tags" content="Transfer Learning">

	                <meta property="og:locale" content="">
		<meta property="og:site_name" content="Cihan Soylu's Blog">

	<meta property="og:type" content="article">
            <meta property="article:author" content="https://cihansoylu.github.io/blog/author/cihan-soylu.html">
	<meta property="og:url" content="https://cihansoylu.github.io/blog/dermatologist-ai.html">
	<meta property="og:title" content="Dermatologist-ai">
	<meta property="article:published_time" content="2018-06-04 00:00:00+02:00">
            <meta property="og:description" content="Load dataset from sklearn.datasets import load_files from keras.utils import np_utils import numpy as np from glob import glob # define...">

            <meta property="og:image" content="https://cihansoylu.github.io/blog/theme/images/post-bg.jpg">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="https://cihansoylu.github.io/blog/">Cihan Soylu's Blog</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">

                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
        <header class="intro-header" style="background-image: url('https://cihansoylu.github.io/blog/theme/images/post-bg.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Dermatologist-ai</h1>
                        <span class="meta">Posted by
                                <a href="https://cihansoylu.github.io/blog/author/cihan-soylu.html">Cihan Soylu</a>
                             on Mon 04 June 2018
                        </span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    <!-- Post Content -->
    <article>
        <h2>Load dataset</h2>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_files</span>       
<span class="kn">from</span> <span class="nn">keras.utils</span> <span class="kn">import</span> <span class="n">np_utils</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>

<span class="c1"># define function to load train, test, and validation datasets</span>
<span class="k">def</span> <span class="nf">load_dataset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">shuffle</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">load_files</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">)</span>
    <span class="n">image_files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;filenames&#39;</span><span class="p">])</span>
    <span class="n">image_targets</span> <span class="o">=</span> <span class="n">np_utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]),</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image_files</span><span class="p">,</span> <span class="n">image_targets</span>

<span class="c1"># load train, test, and validation datasets</span>
<span class="n">train_files</span><span class="p">,</span> <span class="n">train_targets</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;data/train&#39;</span><span class="p">)</span>
<span class="n">valid_files</span><span class="p">,</span> <span class="n">valid_targets</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;data/valid&#39;</span><span class="p">)</span>
<span class="n">test_files</span><span class="p">,</span> <span class="n">test_targets</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;data/test&#39;</span><span class="p">,</span> <span class="n">shuffle</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>


<span class="c1"># print statistics about the dataset</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;There are </span><span class="si">%s</span><span class="s1"> total images.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">train_files</span><span class="p">,</span> <span class="n">valid_files</span><span class="p">,</span> <span class="n">test_files</span><span class="p">])))</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;There are </span><span class="si">%d</span><span class="s1"> training images.&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_files</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;There are </span><span class="si">%d</span><span class="s1"> validation images.&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_files</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;There are </span><span class="si">%d</span><span class="s1"> test images.&#39;</span><span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_files</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span></span>There are 2750 total images.

There are 2000 training images.
There are 150 validation images.
There are 600 test images.
</pre></div>


<h2>Bottleneck Features for Xception</h2>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">keras.preprocessing</span> <span class="kn">import</span> <span class="n">image</span>

<span class="k">def</span> <span class="nf">path_to_tensor</span><span class="p">(</span><span class="n">img_path</span><span class="p">):</span>
    <span class="c1"># loads RGB image as PIL.Image.Image type</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">load_img</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">target_size</span><span class="o">=</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">))</span>
    <span class="c1"># convert PIL.Image.Image type to 3D tensor with shape (512, 512, 3)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">img_to_array</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="c1"># convert 3D tensor to 4D tensor with shape (1, 512, 512, 3) and return 4D tensor</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">paths_to_tensor</span><span class="p">(</span><span class="n">img_paths</span><span class="p">):</span>
    <span class="n">list_of_tensors</span> <span class="o">=</span> <span class="p">[</span><span class="n">path_to_tensor</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span> <span class="k">for</span> <span class="n">img_path</span> <span class="ow">in</span> <span class="n">img_paths</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">list_of_tensors</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">keras.applications.xception</span> <span class="kn">import</span> <span class="n">preprocess_input</span><span class="p">,</span> <span class="n">Xception</span>
<span class="kn">from</span> <span class="nn">keras.models</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">Input</span>

<span class="n">block</span> <span class="o">=</span> <span class="s1">&#39;block4_pool&#39;</span>

<span class="n">base_model</span> <span class="o">=</span> <span class="n">Xception</span><span class="p">(</span><span class="n">include_top</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="s1">&#39;imagenet&#39;</span><span class="p">,</span> <span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">base_model</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">base_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">block</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">bottleneck_features</span><span class="p">(</span><span class="n">img_paths</span><span class="p">):</span>
    <span class="n">img_input</span> <span class="o">=</span> <span class="n">preprocess_input</span><span class="p">(</span><span class="n">paths_to_tensor</span><span class="p">(</span><span class="n">img_paths</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">img_input</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="n">train_bottleneck</span> <span class="o">=</span> <span class="n">bottleneck_features</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">train_files</span><span class="p">))</span>
<span class="n">valid_bottleneck</span> <span class="o">=</span> <span class="n">bottleneck_features</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">valid_files</span><span class="p">))</span>
<span class="n">test_bottleneck</span> <span class="o">=</span> <span class="n">bottleneck_features</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">test_files</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span></span>100%|██████████| 2000/2000 [04:39&lt;00:00,  7.15it/s]
100%|██████████| 150/150 [00:37&lt;00:00,  4.60it/s]
100%|██████████| 600/600 [03:50&lt;00:00,  2.60it/s]
</pre></div>


<div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="s1">&#39;bottleneck_features/bottleneck_features_block4_pool&#39;</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="n">train_bottleneck</span><span class="p">,</span> <span class="n">valid</span> <span class="o">=</span> <span class="n">valid_bottleneck</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">test_bottleneck</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">bottleneck_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;bottleneck_features/bottleneck_features_block4_pool.npz&#39;</span><span class="p">)</span>
<span class="n">train_bottleneck</span> <span class="o">=</span> <span class="n">bottleneck_features</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span>
<span class="n">valid_bottleneck</span> <span class="o">=</span> <span class="n">bottleneck_features</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span>
<span class="n">test_bottleneck</span> <span class="o">=</span> <span class="n">bottleneck_features</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">Conv2D</span><span class="p">,</span> <span class="n">MaxPooling2D</span><span class="p">,</span> <span class="n">GlobalAveragePooling2D</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">Dropout</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">Dense</span>
<span class="kn">from</span> <span class="nn">keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">GlobalAveragePooling2D</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="n">train_bottleneck</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">))</span>

<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span>_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
global_average_pooling2d_2 ( (None, 728)               0         
_________________________________________________________________
dense_2 (Dense)              (None, 3)                 2187      
=================================================================
Total params: 2,187.0
Trainable params: 2,187.0
Non-trainable params: 0.0
_________________________________________________________________
</pre></div>


<div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;rmsprop&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="kn">import</span> <span class="n">ModelCheckpoint</span>   

<span class="c1"># train the model</span>
<span class="n">checkpointer</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="s1">&#39;saved_models/xception.block4.pool.weights.best.hdf5&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                               <span class="n">save_best_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_bottleneck</span><span class="p">,</span> <span class="n">train_targets</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">valid_bottleneck</span><span class="p">,</span> <span class="n">valid_targets</span><span class="p">),</span>
          <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">checkpointer</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>Train on 2000 samples, validate on 150 samples
Epoch 1/20
1984/2000 [============================&gt;.] - ETA: 0s - loss: 0.8246 - acc: 0.6663Epoch 00000: val_loss improved from inf to 0.99720, saving model to saved_models/xception.block4.pool.weights.best.hdf5
2000/2000 [==============================] - 7s - loss: 0.8264 - acc: 0.6660 - val_loss: 0.9972 - val_acc: 0.5333
Epoch 2/20
1984/2000 [============================&gt;.] - ETA: 0s - loss: 0.7414 - acc: 0.6885Epoch 00001: val_loss did not improve
2000/2000 [==============================] - 5s - loss: 0.7390 - acc: 0.6895 - val_loss: 1.0498 - val_acc: 0.5267
Epoch 3/20
1984/2000 [============================&gt;.] - ETA: 0s - loss: 0.7157 - acc: 0.7011Epoch 00002: val_loss improved from 0.99720 to 0.99450, saving model to saved_models/xception.block4.pool.weights.best.hdf5
2000/2000 [==============================] - 5s - loss: 0.7148 - acc: 0.7015 - val_loss: 0.9945 - val_acc: 0.5333
Epoch 4/20
1984/2000 [============================&gt;.] - ETA: 0s - loss: 0.6994 - acc: 0.7092Epoch 00003: val_loss improved from 0.99450 to 0.94912, saving model to saved_models/xception.block4.pool.weights.best.hdf5
2000/2000 [==============================] - 5s - loss: 0.6994 - acc: 0.7095 - val_loss: 0.9491 - val_acc: 0.5800
Epoch 5/20
1984/2000 [============================&gt;.] - ETA: 0s - loss: 0.6926 - acc: 0.7152Epoch 00004: val_loss improved from 0.94912 to 0.90901, saving model to saved_models/xception.block4.pool.weights.best.hdf5
2000/2000 [==============================] - 5s - loss: 0.6929 - acc: 0.7140 - val_loss: 0.9090 - val_acc: 0.5933
Epoch 6/20
1984/2000 [============================&gt;.] - ETA: 0s - loss: 0.6798 - acc: 0.7087Epoch 00005: val_loss did not improve
2000/2000 [==============================] - 5s - loss: 0.6798 - acc: 0.7085 - val_loss: 0.9510 - val_acc: 0.5800
Epoch 7/20
1984/2000 [============================&gt;.] - ETA: 0s - loss: 0.6739 - acc: 0.7137Epoch 00006: val_loss improved from 0.90901 to 0.87726, saving model to saved_models/xception.block4.pool.weights.best.hdf5
2000/2000 [==============================] - 5s - loss: 0.6763 - acc: 0.7130 - val_loss: 0.8773 - val_acc: 0.6200
Epoch 8/20
1984/2000 [============================&gt;.] - ETA: 0s - loss: 0.6718 - acc: 0.7046Epoch 00007: val_loss improved from 0.87726 to 0.86197, saving model to saved_models/xception.block4.pool.weights.best.hdf5
2000/2000 [==============================] - 5s - loss: 0.6721 - acc: 0.7045 - val_loss: 0.8620 - val_acc: 0.6133
Epoch 9/20
1984/2000 [============================&gt;.] - ETA: 0s - loss: 0.6649 - acc: 0.7152Epoch 00008: val_loss did not improve
2000/2000 [==============================] - 5s - loss: 0.6658 - acc: 0.7155 - val_loss: 0.8753 - val_acc: 0.6267
Epoch 10/20
1984/2000 [============================&gt;.] - ETA: 0s - loss: 0.6618 - acc: 0.7162Epoch 00009: val_loss improved from 0.86197 to 0.86041, saving model to saved_models/xception.block4.pool.weights.best.hdf5
2000/2000 [==============================] - 5s - loss: 0.6625 - acc: 0.7165 - val_loss: 0.8604 - val_acc: 0.6200
Epoch 11/20
1984/2000 [============================&gt;.] - ETA: 0s - loss: 0.6522 - acc: 0.7193Epoch 00010: val_loss did not improve
2000/2000 [==============================] - 5s - loss: 0.6536 - acc: 0.7185 - val_loss: 0.9018 - val_acc: 0.6067
Epoch 12/20
1984/2000 [============================&gt;.] - ETA: 0s - loss: 0.6584 - acc: 0.7223Epoch 00011: val_loss did not improve
2000/2000 [==============================] - 5s - loss: 0.6596 - acc: 0.7215 - val_loss: 0.9023 - val_acc: 0.6133
Epoch 13/20
1984/2000 [============================&gt;.] - ETA: 0s - loss: 0.6526 - acc: 0.7182Epoch 00012: val_loss did not improve
2000/2000 [==============================] - 5s - loss: 0.6520 - acc: 0.7190 - val_loss: 0.9678 - val_acc: 0.5467
Epoch 14/20
1984/2000 [============================&gt;.] - ETA: 0s - loss: 0.6520 - acc: 0.7172Epoch 00013: val_loss did not improve
2000/2000 [==============================] - 5s - loss: 0.6531 - acc: 0.7165 - val_loss: 1.0126 - val_acc: 0.5533
Epoch 15/20
1984/2000 [============================&gt;.] - ETA: 0s - loss: 0.6527 - acc: 0.7157Epoch 00014: val_loss did not improve
2000/2000 [==============================] - 5s - loss: 0.6512 - acc: 0.7165 - val_loss: 0.8929 - val_acc: 0.6267
Epoch 16/20
1984/2000 [============================&gt;.] - ETA: 0s - loss: 0.6453 - acc: 0.7177Epoch 00015: val_loss did not improve
2000/2000 [==============================] - 5s - loss: 0.6469 - acc: 0.7165 - val_loss: 0.8750 - val_acc: 0.5933
Epoch 17/20
1984/2000 [============================&gt;.] - ETA: 0s - loss: 0.6469 - acc: 0.7228Epoch 00016: val_loss did not improve
2000/2000 [==============================] - 5s - loss: 0.6464 - acc: 0.7230 - val_loss: 0.9112 - val_acc: 0.6067
Epoch 18/20
1984/2000 [============================&gt;.] - ETA: 0s - loss: 0.6454 - acc: 0.7193Epoch 00017: val_loss did not improve
2000/2000 [==============================] - 5s - loss: 0.6455 - acc: 0.7180 - val_loss: 0.9280 - val_acc: 0.5933
Epoch 19/20
1984/2000 [============================&gt;.] - ETA: 0s - loss: 0.6409 - acc: 0.7172Epoch 00018: val_loss improved from 0.86041 to 0.85187, saving model to saved_models/xception.block4.pool.weights.best.hdf5
2000/2000 [==============================] - 5s - loss: 0.6396 - acc: 0.7185 - val_loss: 0.8519 - val_acc: 0.6200
Epoch 20/20
1984/2000 [============================&gt;.] - ETA: 0s - loss: 0.6378 - acc: 0.7248Epoch 00019: val_loss did not improve
2000/2000 [==============================] - 5s - loss: 0.6374 - acc: 0.7255 - val_loss: 0.8948 - val_acc: 0.6067





&lt;keras.callbacks.History at 0x7f8e1b147710&gt;
</pre></div>


<div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="s1">&#39;saved_models/xception.block4.pool.weights.best.hdf5&#39;</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">predictions</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">test_bottleneck</span><span class="p">]</span>

<span class="c1"># report test accuracy</span>
<span class="n">test_accuracy</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">test_targets</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Test accuracy: </span><span class="si">%.4f%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">test_accuracy</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">roc_curve</span>

<span class="n">pred_prob</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">test_bottleneck</span><span class="p">]</span>
<span class="n">pred_prob_of_mel</span> <span class="o">=</span> <span class="p">[</span><span class="n">prob</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">prob</span> <span class="ow">in</span> <span class="n">pred_prob</span><span class="p">]</span>

<span class="n">vec_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">target_melanoma</span> <span class="o">=</span> <span class="n">vec_int</span><span class="p">(</span><span class="n">test_targets</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">fpr_1</span><span class="p">,</span> <span class="n">tpr_1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">target_melanoma</span><span class="p">,</span> <span class="n">pred_prob_of_mel</span><span class="p">)</span>
<span class="n">roc_auc_1</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr_1</span><span class="p">,</span> <span class="n">tpr_1</span><span class="p">)</span>

<span class="c1">#roc_auc_mel_or_not = roc_auc_score(target_melanoma, pred_prob_of_mel)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;ROC_AUC score for melanoma or not: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">roc_auc_1</span><span class="p">))</span>

<span class="n">pred_ker</span> <span class="o">=</span> <span class="p">[</span><span class="n">prob</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">prob</span> <span class="ow">in</span> <span class="n">pred_prob</span><span class="p">]</span>
<span class="n">target_ker</span> <span class="o">=</span> <span class="n">vec_int</span><span class="p">(</span><span class="n">test_targets</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">fpr_2</span><span class="p">,</span> <span class="n">tpr_2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">target_ker</span><span class="p">,</span> <span class="n">pred_ker</span><span class="p">)</span>
<span class="n">roc_auc_2</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr_2</span><span class="p">,</span> <span class="n">tpr_2</span><span class="p">)</span>

<span class="c1">#roc_auc_mel_or_ker = roc_auc_score(target_ker, pred_ker)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;ROC_AUC score for melanocytes or keratinocytes: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">roc_auc_2</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span></span>Test accuracy: 68.3333%
ROC_AUC score for melanoma or not: 0.6787882005273309
ROC_AUC score for melanocytes or keratinocytes: 0.8398474945533769
</pre></div>


<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">test_files</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Id&#39;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;task_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_prob_of_mel</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;task_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_ker</span>

<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;predictions.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">run</span> <span class="n">get_results</span><span class="o">.</span><span class="n">py</span> <span class="n">predictions</span><span class="o">.</span><span class="n">csv</span>
</pre></div>


<p><img alt="png" src="images/output_14_0.png"></p>
<div class="highlight"><pre><span></span>Category 1 Score: 0.679
Category 2 Score: 0.840
Category 3 Score: 0.759
</pre></div>


<p><img alt="png" src="images/output_14_2.png"></p>
    </article>

        <div class="tags">
            <p>tags: <a href="https://cihansoylu.github.io/blog/tag/keras.html">Keras</a>, <a href="https://cihansoylu.github.io/blog/tag/cnn.html">CNN</a>, <a href="https://cihansoylu.github.io/blog/tag/transfer-learning.html">Transfer Learning</a></p>
        </div>

    <hr>

            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                            <li>
                                <a href="https://github.com/CihanSoylu">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://www.linkedin.com/in/cihan-soylu-749b9088/">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                    </ul>
<p class="copyright text-muted">
    Blog powered by <a href="http://getpelican.com">Pelican</a>,
    which takes great advantage of <a href="http://python.org">Python</a>. <br />        &copy;  Cihan Soylu
</p>                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="https://cihansoylu.github.io/blog/theme/js/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="https://cihansoylu.github.io/blog/theme/js/bootstrap.min.js"></script>

        <!-- Custom Theme JavaScript -->
        <script src="https://cihansoylu.github.io/blog/theme/js/clean-blog.min.js"></script>

</body>

</html>